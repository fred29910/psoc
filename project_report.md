# PSOC 项目详细报告

## 1. 项目概述

PSOC 是一个雄心勃勃的开源项目，旨在利用 Rust 编程语言的强大功能（性能、内存安全、并发性）从头开始构建一款功能丰富的桌面图像编辑应用程序，灵感来源于 Photoshop、GIMP 和 Krita 等优秀软件。

## 2. 项目愿景与目标

*   **高性能：** 利用 Rust 的零成本抽象和对底层控制的能力，实现快速的图像处理和流畅的用户体验。
*   **内存安全：** 借助 Rust 的所有权和借用系统，从根本上减少内存相关的错误和安全漏洞。
*   **现代化：** 采用现代的 UI/UX 设计理念和软件架构。
*   **跨平台：** 目标是支持主流桌面操作系统 (Windows, macOS, Linux)。
*   **模块化与可扩展：** 设计易于维护和扩展的架构，未来可能支持插件系统。
*   **学习与探索：** 探索 Rust 在大型桌面应用程序和图形处理领域的潜力。

## 3. 主要特性

PSOC 作为一个长期项目，特性将逐步实现。目前已实现的核心功能包括：

### 核心引擎
*   高效的 2D 渲染画布 (基于 `iced` 和 `wgpu`)
*   图像文件 I/O (PNG, JPEG, 自定义 PSOC 项目格式)
*   颜色管理 (RGB, HSL, HSV 颜色空间)

### 图层系统
*   基础图层操作 (创建, 删除, 复制, 显隐, 不透明度, 顺序调整)
*   16 种专业图层混合模式 (Normal, Multiply, Screen, Overlay 等)
*   完整的图层渲染引擎
*   调整图层 (非破坏性调整)
*   图层蒙版 (选择性编辑)
*   智能对象/图层 (非破坏性变换)

### 工具系统
*   工具抽象与管理架构
*   统一的工具事件处理系统
*   工具选项配置系统
*   工具切换和状态管理

### 选择工具
*   基础选择工具框架
*   矩形、椭圆选区实现
*   套索、魔棒工具
*   选区操作和渲染

### 绘图与编辑工具
*   画笔工具 (可调大小、硬度、颜色)
*   橡皮擦工具 (专业级 Alpha 通道擦除)
*   移动工具 (图层和选区移动)
*   变换工具 (缩放、旋转、翻转)
*   文本工具 (字体、大小、颜色、对齐)
*   渐变工具 (线性、径向、角度、菱形渐变)
*   形状工具 (矩形、椭圆、线条、多边形)
*   裁剪工具 (自由、固定比例、正方形)
*   吸管工具 (颜色拾取)

### 图像调整与滤镜
*   亮度/对比度, 色相/饱和度/明度, 灰度化, 色彩平衡
*   色阶、曲线调整 (高级调整功能)
*   常见滤镜 (高斯模糊、运动模糊、锐化、降噪、添加噪点等)

### 用户界面
*   直观的图形用户界面 (使用 `iced`)
*   图层面板和画布显示
*   文件对话框集成
*   工具选项面板 (动态工具配置)
*   状态栏与信息面板 (实时信息显示)
*   颜色选择器与调色板
*   撤销/重做系统 (完整实现)
*   历史记录面板
*   标尺、网格、参考线
*   键盘快捷键系统 (32 种快捷键)

### 高级功能
*   非破坏性编辑工作流 (调整图层、智能对象)
*   颜色管理系统 (ICC 配置文件支持)
*   (计划) 脚本/插件支持 (可能通过 Lua/WASM)

## 4. 项目架构

PSOC 项目采用模块化架构，主要分为以下几个核心部分：

### 核心 crates (位于 `crates/` 目录)
*   **`psoc-core`**: 图像编辑的核心逻辑库，包含颜色、几何、图层、像素、渲染、选择、智能对象、命令以及各种图像调整（如亮度、对比度、曲线、灰度、HSL、色阶）和滤镜（如高斯模糊）的实现。
*   **`psoc-image-processing`**: 专注于图像处理算法的独立库。
*   **`psoc-file-formats`**: 负责处理各种图像文件格式的导入和导出，目前支持 JPEG, PNG 和自定义的 PSOC 项目格式。
*   **`psoc-ui-toolkit`**: 提供构建用户界面所需的 UI 组件、布局、主题和小部件。
*   **`psoc-plugins`**: 负责插件系统的管理和加载，支持 Lua 和 WASM 插件。

### 主应用程序 (`src/` 目录)
*   **`src/main.rs`**: 应用程序的入口点，整合所有核心模块和 UI 组件，启动主应用。
*   **`src/lib.rs`**: 主库文件，可能包含一些顶层抽象或公共接口。
*   **`src/app/`**: 应用程序的顶层逻辑和状态管理。
*   **`src/commands/`**: 实现各种用户操作的命令模式，包括调整、裁剪、图层、绘画、选择、智能对象和变换命令。
*   **`src/core/`**: 包含应用程序的核心业务逻辑和数据模型。
*   **`src/file_io/`**: 负责文件的导入和导出逻辑。
*   **`src/i18n/`**: 国际化（i18n）系统，支持多语言。
*   **`src/image_processing/`**: 应用程序层面的图像处理相关逻辑。
*   **`src/plugins/`**: 应用程序层面的插件集成逻辑。
*   **`src/preferences/`**: 用户偏好设置的管理。
*   **`src/rendering/`**: 应用程序层面的渲染逻辑。
*   **`src/shortcuts/`**: 键盘快捷键管理系统。
*   **`src/tools/`**: 定义和管理各种图像编辑工具，包括工具管理器和工具特性。
*   **`src/ui/`**: 用户界面相关的实现，包括主应用程序界面、画布、动画、UI 组件（如工具栏、菜单系统、面板）、设计系统（颜色、间距、边框、可访问性）和各种对话框。
*   **`src/utils/`**: 通用工具函数。

### 其他辅助目录
*   **`benches/`**: 性能基准测试。
*   **`docs/`**: 项目文档、设计文件和报告。
*   **`examples/`**: 各种功能的使用示例。
*   **`resources/`**: 应用程序资源，如字体、国际化文件、图标。
*   **`scripts/`**: 构建、打包和资源生成脚本。
*   **`tests/`**: 单元测试和集成测试。

这种模块化设计使得项目结构清晰，各部分职责明确，有利于团队协作和未来的功能扩展。

## 5. 技术栈

PSOC 项目主要采用 Rust 语言，并利用其强大的生态系统：

*   **语言：** Rust
*   **GUI 框架：** `iced` (现代化的 Rust GUI 框架)
*   **渲染后端：** `wgpu` (通过 `iced`) + `tiny-skia`
*   **图像处理：** `image`, `ndarray`, `rayon`
*   **异步运行时：** `tokio`
*   **序列化：** `serde`, `ron`
*   **错误处理：** `anyhow`, `thiserror`
*   **日志：** `tracing`, `tracing-subscriber`
*   **国际化 (i18n)：** `fluent`, `fluent-bundle`, `unic-langid`, `rust-embed`, `sys-locale`
*   **并发：** `parking_lot`, `dashmap`
*   **数学：** `glam`
*   **文件对话框：** `rfd`
*   **系统工具：** `dirs`, `num_cpus`
*   **插件系统 (可选)：** `mlua` (Lua), `wasmtime` (WASM)

## 5. 项目状态与路线图

本项目目前处于 **Alpha 开发阶段**。

### 已完成的里程碑：
*   ✅ **P0阶段**: 项目基础设施和架构设计
*   ✅ **P1阶段**: 核心数据结构、文件IO、错误处理、GUI基础
*   ✅ **P2.1**: 图层数据结构实现
*   ✅ **P2.2**: 图层UI面板开发
*   ✅ **P2.3**: 图层混合与渲染
*   ✅ **P2.4**: 多图层项目文件支持
*   ✅ **P3.1**: 工具抽象与管理系统
*   ✅ **P3.2**: 选区工具实现
*   ✅ **P3.3**: 画笔工具实现
*   ✅ **P3.4**: 橡皮擦工具实现
*   ✅ **P3.5**: 移动工具实现
*   ✅ **P3.6**: 撤销/重做系统架构
*   ✅ **P4.1**: 调整/滤镜框架
*   ✅ **P4.2**: 亮度/对比度调整UI
*   ✅ **P4.3**: 更多调整类型开发
*   ✅ **P4.4**: 高级调整功能 (曲线、色阶、高级滤镜)
*   ✅ **P4.5**: 高斯模糊UI实现
*   ✅ **P4.6**: 图像变换功能 (Transform工具)
*   ✅ **P5.1**: 工具选项面板实现
*   ✅ **P5.2**: 状态栏与信息面板开发
*   ✅ **P5.3**: 颜色选择器与调色板开发
*   ✅ **P5.4**: 标尺、网格与参考线功能
*   ✅ **P5.5**: 键盘快捷键系统开发
*   ✅ **P5.6**: 颜色管理系统(CMS)初步集成
*   ✅ **P5.7**: 历史记录面板开发
*   ✅ **P6.1**: 高级选区工具 (椭圆、套索、魔棒)
*   ✅ **P6.2**: 文本工具开发
*   ✅ **P6.3**: 渐变工具开发
*   ✅ **P6.4**: 形状工具开发
*   ✅ **P6.5**: 更多混合模式开发
*   ✅ **P6.6**: 裁剪工具开发
*   ✅ **P6.7**: 吸管工具开发
*   ✅ **P7.1**: 调整图层开发
*   ✅ **P7.2**: 图层蒙版功能开发
*   ✅ **P7.3**: 智能对象/图层开发 ⭐

### 当前状态 (P7.3完成)：
*   **206个单元测试** 全部通过（包含13个智能对象专项测试）
*   **完整的图层系统** 支持像素图层、调整图层、智能对象图层
*   **16种专业混合模式** 完整 GUI 支持和渲染集成
*   **项目文件格式** 支持保存/加载多图层文档和智能对象
*   **完整的工具系统** 10 种专业工具，包含工具选项面板
*   **选区工具** 矩形、椭圆、套索、魔棒四种选区工具
*   **绘图工具** 画笔、橡皮擦、文本、渐变、形状工具
*   **编辑工具** 移动、变换、裁剪、吸管工具
*   **非破坏性编辑** 调整图层、图层蒙版、智能对象系统
*   **高级 UI 功能** 工具选项、状态栏、颜色管理、历史记录
*   **调整/滤镜系统** 9 种调整类型和 6 种专业滤镜
*   **撤销/重做系统** 完整的命令模式实现
*   **键盘快捷键** 32 种快捷键支持
*   **颜色管理** ICC 配置文件支持
*   **智能对象系统** ⭐ 非破坏性变换和内容管理
*   **代码质量** 零编译错误，零警告，优秀架构设计

详细的开发文档可以在 `docs/` 目录中找到。

## 6. 构建与运行

**先决条件：**
*   安装最新稳定版的 [Rust 工具链](https://www.rust-lang.org/tools/install) (rustc, cargo)。
*   (可选) 如果你选择的 GUI 框架有其他系统依赖（例如 `gtk-rs` 需要 GTK 开发库），请根据其文档安装。

**构建步骤：**
1.  克隆仓库：
    ```bash
    git clone https://github.com/YOUR_USERNAME/YOUR_REPONAME.git
    cd YOUR_REPONAME
    ```
2.  构建项目：
    *   调试构建：
        ```bash
        cargo build
        ```
    *   发行构建 (优化性能)：
        ```bash
        cargo build --release
        ```
3.  运行应用程序：
    *   调试模式：
        ```bash
        cargo run
        ```
    *   发行模式：
        ```bash
        cargo run --release
        # 或者直接运行target/release/[executable_name]
        ```

## 7. 贡献指南

我们热烈欢迎各种形式的贡献！无论是代码、文档、Bug 报告还是功能建议。

1.  **报告 Bug 或建议功能：** 请通过 [GitHub Issues](https://github.com/YOUR_USERNAME/YOUR_REPONAME/issues) 提交。
2.  **参与开发：**
    *   Fork 本仓库。
    *   创建一个新的特性分支 (`git checkout -b feature/AmazingFeature`)。
    *   提交你的更改 (`git commit -m 'Add some AmazingFeature'`)。
    *   将分支推送到你的 Fork (`git push origin feature/AmazingFeature`)。
    *   创建一个 Pull Request。
3.  **代码风格：** 请运行 `rustfmt` 和 `clippy` 以确保代码风格一致并通过静态检查。
    ```bash
    cargo fmt
    cargo clippy -- -D warnings
    ```

请查阅 `CONTRIBUTING.md` (如果创建了该文件) 获取更详细的贡献指南。

## 8. 开源许可

本项目采用双重许可： **MIT License** 和 **Apache License 2.0**。
你可以根据自己的需求选择其中任一许可。

*   [LICENSE-MIT](LICENSE-MIT)
*   [LICENSE-APACHE](LICENSE-APACHE)

(除非你另有说明，否则你的所有贡献都将默认采用此双重许可。)

## 9. 致谢

*   感谢所有为 Rust 生态系统做出贡献的开发者。
*   感谢 [GIMP](https://www.gimp.org/), [Krita](https://krita.org/), [Photoshop](https://www.adobe.com/products/photoshop.html) 等优秀软件提供的灵感。
*   感谢以下关键 crates 的作者和维护者：
    *   `image`
    *   `wgpu` / `iced`
    *   `ndarray`
    *   `lcms2-rs` (如果用到)
    *   ... (其他你用到的重要库)

---

**免责声明：** 这是一个爱好者驱动的复杂项目，开发周期可能较长。请耐心等待并欢迎加入我们一起构建！