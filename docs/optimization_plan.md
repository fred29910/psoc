# 项目优化规划：psoc

**目标：** 提升 `psoc` 应用的性能、代码质量和可维护性，并优化其架构设计。

---

### **阶段一：核心性能优化 (短期，高优先级)**

**目标：** 通过针对性的代码优化，显著提升图像处理速度，尤其是在处理大型图像和复杂图层时。

**任务列表：**

1.  **重构 `PixelData` 访问和迭代器 (预计性能提升：5-15%)**
    *   **描述：** 为 `PixelData` 实现高效的、并行友好的像素迭代器（例如，实现 `rayon` 的 `IntoParallelIterator`），提供 `pixels_par_iter_mut()` 和 `pixels_par_iter()` 等方法。这是后续并行化优化的基础。
    *   **可量化目标：** 确保 `PixelData` 的并行迭代效率不低于顺序迭代，并为后续任务提供稳定的并行接口。

2.  **全面并行化像素级调整算法 (预计性能提升：10-30%)**
    *   **描述：** 利用重构后的 `PixelData` 迭代器，将 `crates/psoc-core/src/adjustments/` 模块中的所有 `apply` 方法（如 `BrightnessAdjustment::apply`）并行化。
    *   **可量化目标：** 单个调整操作在多核CPU上的执行时间缩短至少10%。

3.  **优化 `composite_layer_parallel` 的像素写入 (预计性能提升：5-10%)**
    *   **描述：** 改进 `composite_layer_parallel` 中瓦片处理后的像素写入机制，避免中间集合 `all_tile_updates_results`，减少不必要的内存分配和拷贝开销。可以考虑直接在 `PixelData` 内部进行线程安全写入，或每个瓦片渲染到独立区域再合并。
    *   **可量化目标：** 图层合成操作的内存峰值降低5%以上，执行时间缩短5%以上。

4.  **并行化 `blend_adjustment_result` (预计性能提升：5-10%)**
    *   **描述：** 确保调整层混合时也能充分利用并行计算，对 `blend_adjustment_result` 方法进行并行化处理。
    *   **可量化目标：** 调整层混合操作的执行时间缩短5%以上。

---

### **阶段二：代码质量与架构清晰 (中期，中等优先级)**

**目标：** 提升代码库的可读性、可维护性性，和模块职责的清晰度，为未来开发奠定基础。

**任务列表：**

1.  **明确 `psoc-image-processing` 的职责**
    *   **描述：** 根据项目长期规划，决定是移除 `crates/psoc-image-processing` 这个空壳 crate，将其功能合并到 `psoc-core`；还是将其填充为独立的图像算法库，并将 `psoc-core/src/rendering.rs` 中的具体像素操作和 `adjustments` 模块迁移过去。
    *   **可量化目标：** `psoc-image-processing` 模块的功能定位明确，无职责重叠。

2.  **抽象通用像素处理模式 (预计代码重复减少：10-20%)**
    *   **描述：** 在 `PixelData` 或 `Adjustment` trait 中引入通用方法（如 `map_pixels_par`），以减少 `adjustments` 模块中像素处理逻辑的代码重复。
    *   **可量化目标：** `adjustments` 模块中重复代码行数减少10%以上。

3.  **完善 `rustdoc` 文档和内部注释 (预计文档覆盖率提升：20-40%)**
    *   **描述：** 对所有公共模块、结构体、枚举、trait 和函数添加清晰的 `rustdoc` 注释，包括用途、参数、返回值和使用示例。对于复杂算法和设计决策，添加详细的内部注释。
    *   **可量化目标：** 核心模块（`psoc-core`）的公共API文档覆盖率达到90%以上。

4.  **细化错误类型 (预计错误诊断效率提升：10-20%)**
    *   **描述：** 在关键模块中使用 `thiserror` 定义更具体的错误类型，而不是都使用 `anyhow::anyhow!`，以便更好地进行错误诊断和处理。
    *   **可量化目标：** 核心功能模块的错误类型细化程度提升，减少通用错误类型的使用。

---

### **阶段三：高级功能与未来扩展 (长期，低优先级)**

**目标：** 引入先进技术，提升应用的用户体验、扩展性和长期竞争力。

**任务列表：**

1.  **GPU 加速研究与初步实现 (预计渲染性能提升：20-50%)**
    *   **描述：** 评估并逐步引入 `wgpu` 或类似库，将部分渲染和图像处理任务（如图层混合、滤镜应用）迁移到 GPU。
    *   **可量化目标：** 至少一项核心渲染操作（例如，特定滤镜或图层合成）实现GPU加速，其执行时间缩短20%以上。

2.  **异步任务调度与 UI 响应性优化 (预计 UI 阻塞时间减少：50%以上)**
    *   **描述：** 优化后台任务管理，对于耗时操作（渲染、滤镜、文件I/O），确保在后台线程执行，并通过异步通信机制避免阻塞主 UI 线程。实现任务取消和进度报告机制。
    *   **可量化目标：** 在执行耗时操作时，UI 保持流畅响应，无明显卡顿，任务取消和进度报告功能正常。

3.  **插件系统增强 (预计插件安全性、性能和开发者体验提升)**
    *   **描述：** 进一步提升插件的安全性（沙箱环境）、数据传输性能和开发者体验（提供清晰文档、示例和工具）。
    *   **可量化目标：** 插件加载和执行的内存隔离和性能达到预期，插件开发文档完整易懂。

4.  **国际化全面覆盖**
    *   **描述：** 确保所有用户可见的字符串，包括动态生成的 UI 文本（错误消息、状态栏信息、对话框内容），都通过国际化系统（Fluent FTL）进行管理，而非硬编码。
    *   **可量化目标：** UI 文本的国际化覆盖率达到95%以上，支持至少两种语言（中/英）。
